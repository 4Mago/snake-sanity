{"version":3,"sources":["../../src/components/Video.js"],"names":["NOOP","propTypes","assetDocument","PropTypes","object","isRequired","autoload","bool","onCancel","func","onReady","MuxVideo","Component","constructor","props","React","createRef","event","setState","showControls","hls","startLoad","state","posterUrl","source","isLoading","error","isDeletedOnMux","secrets","getDerivedStateFromProps","nextProps","status","componentDidMount","video","then","componentDidUpdate","prevProps","prevState","resolveSourceAndPoster","current","src","attachVideo","destroy","playbackId","options","isSigned","data","playback_ids","policy","signingKeyId","signingKeyPrivate","getVideoElement","Hls","isSupported","autoStartLoad","loadSource","attachMedia","on","Events","MANIFEST_PARSED","videoContainer","style","display","ERROR","type","ErrorTypes","NETWORK_ERROR","assetId","response","catch","err","message","match","console","canPlayType","addEventListener","render","styles","progressBar","uploadCancelButton","handleCancelButtonClicked","root","handleVideoClick","videoError","join"],"mappings":"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","sourcesContent":["import React, {Component} from 'react'\nimport PropTypes from 'prop-types'\nimport Hls from 'hls.js'\nimport ProgressBar from 'part:@sanity/components/progress/bar'\nimport Button from 'part:@sanity/components/buttons/default'\n\nimport {getAsset} from '../actions/assets'\nimport {fetchSecrets} from '../actions/secrets'\nimport getPosterSrc from '../util/getPosterSrc'\nimport getVideoSrc from '../util/getVideoSrc'\n\nimport styles from './Video.css'\n\nconst NOOP = () => {\n  /* intentional noop */\n}\n\nconst propTypes = {\n  assetDocument: PropTypes.object.isRequired,\n  autoload: PropTypes.bool,\n  onCancel: PropTypes.func,\n  onReady: PropTypes.func,\n}\n\nclass MuxVideo extends Component {\n  static defaultProps = {\n    autoload: true,\n  }\n\n  videoContainer = React.createRef()\n  hls = null\n\n  constructor(props) {\n    super(props)\n    this.state = {\n      posterUrl: null,\n      source: null,\n      isLoading: true,\n      error: null,\n      isDeletedOnMux: false,\n      secrets: null,\n    }\n  }\n\n  // eslint-disable-next-line complexity\n  static getDerivedStateFromProps(nextProps) {\n    let isLoading = true\n    const {assetDocument} = nextProps\n    if (assetDocument && assetDocument.status === 'preparing') {\n      isLoading = 'Preparing the video'\n    }\n    if (assetDocument && assetDocument.status === 'waiting_for_upload') {\n      isLoading = 'Waiting for upload to start'\n    }\n    if (assetDocument && assetDocument.status === 'waiting') {\n      isLoading = 'Processing upload'\n    }\n    if (assetDocument && assetDocument.status === 'ready') {\n      isLoading = false\n    }\n    if (assetDocument && typeof assetDocument.status === 'undefined') {\n      isLoading = false\n    }\n    return {isLoading}\n  }\n\n  componentDidMount() {\n    this.video = React.createRef()\n    this.setState(MuxVideo.getDerivedStateFromProps(this.props))\n    fetchSecrets().then(({secrets}) => this.setState({secrets}))\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if (!this.state.isLoading && this.state.secrets && this.state.source === null) {\n      this.resolveSourceAndPoster(this.props.assetDocument)\n    }\n\n    if (this.state.source !== null && this.video.current && !this.video.current.src) {\n      // eslint-disable-next-line react/no-did-update-set-state\n      this.setState({error: null})\n      this.attachVideo()\n    }\n\n    if (this.state.source !== null && this.state.source !== prevState.source) {\n      // eslint-disable-next-line react/no-did-update-set-state\n      this.setState({error: null, showControls: false})\n      if (this.hls) {\n        this.hls.destroy()\n      }\n      this.attachVideo()\n    }\n  }\n\n  resolveSourceAndPoster(assetDocument) {\n    const playbackId = assetDocument.playbackId\n    const options = {\n      isSigned: assetDocument.data.playback_ids[0].policy === 'signed',\n      signingKeyId: this.state.secrets.signingKeyId || null,\n      signingKeyPrivate: this.state.secrets.signingKeyPrivate || null,\n    }\n\n    const source = getVideoSrc(playbackId, options)\n    const posterUrl = getPosterSrc(playbackId, options)\n    this.setState({source, posterUrl})\n  }\n\n  getVideoElement() {\n    return this.video && this.video.current\n  }\n\n  attachVideo() {\n    const {assetDocument, autoload} = this.props\n    if (Hls.isSupported()) {\n      this.hls = new Hls({autoStartLoad: autoload})\n      this.hls.loadSource(this.state.source)\n      this.hls.attachMedia(this.video.current)\n      this.hls.on(Hls.Events.MANIFEST_PARSED, () => {\n        if (this.videoContainer.current) {\n          this.videoContainer.current.style.display = 'block'\n        }\n        if (this.props.onReady) {\n          this.props.onReady()\n        }\n      })\n      this.hls.on(Hls.Events.ERROR, (event, data) => {\n        switch (data.type) {\n          case Hls.ErrorTypes.NETWORK_ERROR:\n            if (this.videoContainer.current) {\n              this.videoContainer.current.style.display = 'none'\n            }\n            this.setState({error: data})\n            getAsset(assetDocument.assetId)\n              .then((response) => {\n                this.setState({isDeletedOnMux: false})\n              })\n              .catch((err) => {\n                if (err.message.match(/404/)) {\n                  this.setState({isDeletedOnMux: true})\n                  return\n                }\n                console.error(data, err) // eslint-disable-line no-console\n              })\n            break\n          default:\n            console.error(data) // eslint-disable-line no-console\n        }\n      })\n    } else if (this.video.current.canPlayType('application/vnd.apple.mpegurl')) {\n      this.video.current.src = this.state.source\n      this.video.current.addEventListener('loadedmetadata', () => {\n        this.hls.loadSource(this.state.source)\n        this.hls.attachMedia(this.video.current)\n      })\n    }\n  }\n\n  handleVideoClick = (event) => {\n    this.setState({showControls: true})\n    this.hls.startLoad(0)\n    if (this.props.onReady) {\n      this.props.onReady(event)\n    }\n  }\n\n  handleCancelButtonClicked = (event) => {\n    if (this.props.onCancel) {\n      this.props.onCancel(event)\n    }\n  }\n\n  // eslint-disable-next-line complexity\n  render() {\n    const {posterUrl, isLoading, error} = this.state\n    const {assetDocument, autoload} = this.props\n    if (!assetDocument || !assetDocument.status) {\n      return null\n    }\n\n    if (isLoading) {\n      return (\n        <div>\n          <div className={styles.progressBar}>\n            <ProgressBar\n              percent={100}\n              text={(isLoading !== true && isLoading) || 'Waiting for MUX to complete the file'}\n              isInProgress\n              showPercent\n              animation\n              color=\"primary\"\n            />\n          </div>\n          <div className={styles.uploadCancelButton}>\n            <Button onClick={this.handleCancelButtonClicked}>Cancel</Button>\n          </div>\n        </div>\n      )\n    }\n\n    const showControls = autoload || this.state.showControls\n    return (\n      <div>\n        <div ref={this.videoContainer} className={styles.videoContainer}>\n          <video\n            className={styles.root}\n            onClick={autoload ? NOOP : this.handleVideoClick}\n            controls={showControls}\n            ref={this.video}\n            poster={posterUrl}\n          />\n        </div>\n        {error && (\n          <div className={[styles.videoContainer, styles.videoError].join(' ')}>\n            <p>\n              There was an error loading this video ({error.type}\n              ).\n            </p>\n            {this.state.isDeletedOnMux && (\n              <p>\n                <strong>The video is deleted on MUX.com</strong>\n              </p>\n            )}\n          </div>\n        )}\n      </div>\n    )\n  }\n}\n\nMuxVideo.propTypes = propTypes\n\nexport default MuxVideo\n"],"file":"Video.js"}